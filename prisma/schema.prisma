// This usage of Prisma Schema is for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum Role {
  ADMIN
  STAFF
  TENANT
  LANDLORD // Added
  USER // Fallback/Default
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

enum PropertyStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  SOLD
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ApprovalStatus {
  PENDING_MANAGER
  PENDING_ADMIN
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum NotificationType {
  MAINTENANCE
  PAYMENT
  CHAT
  ALERT
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  phone         String?   // New: For Login
  emailVerified DateTime?
  image         String?
  password      String?
  resetToken    String?
  resetTokenExpiry DateTime?
  role          Role      @default(USER)
  status        UserStatus @default(ACTIVE) // Approval flow

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Tenant Specifics
  nextOfKinName  String?
  nextOfKinPhone String?
  employerName   String?
  jobTitle       String?
  isEmployed     Boolean   @default(false)

  // Relations
  tickets         Ticket[]
  leases          Lease[]
  payments        Payment[]
  activityLogs    ActivityLog[]
  contactSubmissions ContactSubmission[]
  documents       Document[]
  comments        TicketComment[]
  managedProperties Property[] @relation("PropertyManager") // Staff managing properties
  ownedProperties   Property[] @relation("PropertyOwner") // Landlord's properties
  rentModifications RentModificationLog[] @relation("AdminModifier")
  claimedTickets   Ticket[]              @relation("TicketClaimant")
  notifications    Notification[]
}

model Property {
  id          String         @id @default(cuid())
  title       String
  description String
  location    String
  price       Float
  status      PropertyStatus @default(AVAILABLE)
  program     String?        // e.g. "Lagos HOMS", "Rent-to-Own"
  type        String?        // e.g. "Apartment", "House"
  
  images      String[]       // Postgres Array for images
  features    String[]       // Postgres Array for features
  
  bedrooms    Int?
  bathrooms   Int?
  sqft        Int?
  
  // Relations
  leases      Lease[]
  payments    Payment[]      // Linked payments for landlord visibility
  managerId   String?        // Staff responsible
  manager     User?          @relation("PropertyManager", fields: [managerId], references: [id])

  ownerId     String?        // Making optional initially to facilitate migration of existing data, but will enforce in app logic
  owner       User?          @relation("PropertyOwner", fields: [ownerId], references: [id])

  // Multi-unit Support
  isMultiUnit Boolean        @default(false)
  parentId    String?        // If this is a unit, link to the building
  parent      Property?      @relation("Units", fields: [parentId], references: [id])
  units       Property[]     @relation("Units")
  unitNumber  String?        // e.g., "Flat 101"
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Lease {
  id          String   @id @default(cuid())
  startDate   DateTime
  endDate     DateTime? // Indefinite or fixed
  rentAmount  Float
  isActive    Boolean  @default(true)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  rentLogs    RentModificationLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Ticket {
  id             String         @id @default(cuid())
  subject        String
  description    String?
  status         TicketStatus   @default(OPEN)
  priority       TicketPriority @default(MEDIUM)
  category       String // Plumbing, Electrical, etc.
  
  images         String[]     // Postgres Array
  
  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  assignedToId   String?
  // assignedTo  User? ... (Future: Staff assignment)

  claimedById    String?
  claimant       User?           @relation("TicketClaimant", fields: [claimedById], references: [id])

  // Approval Workflow
  requiresApproval Boolean        @default(false)
  approvalStatus   ApprovalStatus @default(APPROVED) // Default approved unless requires approval
  approvedById     String?        // Admin who approved

  comments       TicketComment[]
  
  notifications  Notification[]

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String?
  link      String?          // e.g. /admin/tickets/id
  isRead    Boolean          @default(false)

  ticketId  String?
  ticket    Ticket?          @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  createdAt DateTime         @default(now())
}

model TicketComment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id             String        @id @default(cuid())
  amount         Float
  currency       String        @default("NGN")
  reference      String        @unique
  method         String        // 'Paystack', 'Transfer', 'Cash'
  status         String        // 'SUCCESS', 'PENDING', 'FAILED' (Simple string for API mapping)
  
  approvalStatus ApprovalStatus @default(APPROVED) // If manual transfer, needs approval

  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  propertyId     String?       // Make optional for existing payments
  property       Property?     @relation(fields: [propertyId], references: [id])
  
  createdAt      DateTime      @default(now())
}

model Material {
  id          String   @id @default(cuid())
  name        String
  category    String
  description String?
  price       Float?
  quantity    Int      @default(0)
  minThreshold Int     @default(5)
  inStock     Boolean  @default(true)
  location    String?  // 'Store A', 'Site B'

  images      String[] // Postgres Array

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String
  status    String   @default("UNREAD") // READ, UNREAD, REPLIED
  
  // Optional linkage if logged in
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model Document {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String   // 'LEASE', 'RECEIPT', 'ID'
  category  String?  // 'Kyc', 'Contract'
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model ActivityLog {
  id          String   @id @default(cuid())
  action      String   // LOGIN, CREATE, UPDATE, DELETE, APPROVE
  entity      String   // TICKET, USER, PAYMENT
  entityId    String?
  details     String?  // JSON string of changes
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

model RentModificationLog {
  id             String   @id @default(cuid())
  leaseId        String
  lease          Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  
  previousAmount Float
  newAmount      Float
  reason         String?
  
  adminId        String
  admin          User     @relation("AdminModifier", fields: [adminId], references: [id])
  
  createdAt      DateTime @default(now())
}
