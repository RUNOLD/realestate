generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                @id @default(cuid())
  name                    String?
  email                   String                @unique
  phone                   String?
  emailVerified           DateTime?
  image                   String?
  password                String?
  resetToken              String?
  resetTokenExpiry        DateTime?
  role                    Role                  @default(USER)
  status                  UserStatus            @default(ACTIVE)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  nextOfKinName           String?
  nextOfKinPhone          String?
  employerName            String?
  jobTitle                String?
  isEmployed              Boolean               @default(false)
  notificationPreferences Json?
  accountName             String?
  accountNumber           String?
  bankName                String?
  department              String?
  hireDate                DateTime?
  homeAddress             String?
  salary                  Float?
  uniqueId                String?               @unique
  blacklistReason         String?
  activityLogs            ActivityLog[]
  contactSubmissions      ContactSubmission[]
  documents               Document[]
  landlordExpenses        LandlordExpense[]
  landlordProfile         LandlordProfile?
  leases                  Lease[]
  monthlyMetrics          MonthlyMetric[]
  notifications           Notification[]
  payments                Payment[]
  payouts                 Payout[]
  managedProperties       Property[]            @relation("PropertyManager")
  ownedProperties         Property[]            @relation("PropertyOwner")
  rentCycles              RentCycle[]
  rentModifications       RentModificationLog[] @relation("AdminModifier")
  tenantProfile           TenantProfile?
  claimedTickets          Ticket[]              @relation("TicketClaimant")
  landlordTickets         Ticket[]              @relation("TicketLandlord")
  tickets                 Ticket[]
  comments                TicketComment[]
  utilityTransactions     UtilityTransaction[]
}

model Property {
  id                  String               @id @default(cuid())
  title               String
  description         String
  location            String
  price               Float
  status              PropertyStatus       @default(AVAILABLE)
  program             String?
  type                String?
  images              String[]
  features            String[]
  managerId           String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  bathrooms           Int?
  bedrooms            Int?
  sqft                Int?
  isMultiUnit         Boolean              @default(false)
  ownerId             String?
  parentId            String?
  unitNumber          String?
  uniqueId            String?              @unique
  cautionDeposit      Float?               @default(0)
  serviceCharge       Float?               @default(0)
  managementFee       Float                @default(10)
  expenses            LandlordExpense[]
  leases              Lease[]
  monthlyMetrics      MonthlyMetric[]
  payments            Payment[]
  payouts             Payout[]             @relation("PropertyPayouts")
  manager             User?                @relation("PropertyManager", fields: [managerId], references: [id])
  owner               User?                @relation("PropertyOwner", fields: [ownerId], references: [id])
  parent              Property?            @relation("Units", fields: [parentId], references: [id])
  units               Property[]           @relation("Units")
  tickets             Ticket[]
  unitsTickets        Ticket[]             @relation("TicketUnit")
  utilityTransactions UtilityTransaction[]

  @@index([location])
  @@index([type])
}

model Lease {
  id              String                @id @default(cuid())
  startDate       DateTime
  endDate         DateTime?
  rentAmount      Float
  isActive        Boolean               @default(true)
  userId          String
  propertyId      String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  billingCycle    BillingCycle          @default(MONTHLY)
  terminationDate DateTime?
  property        Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  rentLogs        RentModificationLog[]
}

model Ticket {
  id                       String                   @id @default(cuid())
  subject                  String
  description              String?
  status                   TicketStatus             @default(PENDING)
  priority                 TicketPriority           @default(MEDIUM)
  category                 String
  images                   String[]
  userId                   String
  assignedToId             String?
  requiresApproval         Boolean                  @default(false)
  approvalStatus           ApprovalStatus           @default(APPROVED)
  approvedById             String?
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  claimedById              String?
  costActual               Decimal?                 @db.Decimal(10, 2)
  costEstimated            Decimal?                 @db.Decimal(10, 2)
  resolutionDate           DateTime?
  resolutionNote           String?
  resolvedBy               String?
  landlordId               String?
  propertyId               String?
  rentCycleId              String?
  unitId                   String?
  artisanName              String?
  artisanPhone             String?
  payerType                TicketPayerType?         @default(LANDLORD)
  tenantConfirmationStatus TenantConfirmationStatus @default(PENDING)
  expense                  LandlordExpense?
  notifications            Notification[]
  claimant                 User?                    @relation("TicketClaimant", fields: [claimedById], references: [id])
  landlord                 User?                    @relation("TicketLandlord", fields: [landlordId], references: [id])
  property                 Property?                @relation(fields: [propertyId], references: [id])
  rentCycle                RentCycle?               @relation(fields: [rentCycleId], references: [id])
  unit                     Property?                @relation("TicketUnit", fields: [unitId], references: [id])
  user                     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments                 TicketComment[]
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String?
  link      String?
  isRead    Boolean          @default(false)
  ticketId  String?
  createdAt DateTime         @default(now())
  ticket    Ticket?          @relation(fields: [ticketId], references: [id])
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TicketComment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  ticketId  String
  userId    String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id             String         @id @default(cuid())
  amount         Float
  currency       String         @default("NGN")
  reference      String         @unique
  method         String
  status         String
  approvalStatus ApprovalStatus @default(APPROVED)
  userId         String
  createdAt      DateTime       @default(now())
  propertyId     String?
  category       String         @default("RENT")
  property       Property?      @relation(fields: [propertyId], references: [id])
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Material {
  id           String   @id @default(cuid())
  name         String
  category     String
  description  String?
  price        Float?
  quantity     Int      @default(0)
  minThreshold Int      @default(5)
  inStock      Boolean  @default(true)
  location     String?
  images       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  uniqueId     String?  @unique
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String
  status    String   @default("UNREAD")
  userId    String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model Document {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String
  category  String?
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ActivityLog {
  id            String   @id @default(cuid())
  action        String
  entity        String
  entityId      String?
  details       String?
  userId        String?
  createdAt     DateTime @default(now())
  ipAddress     String?
  newState      String?
  previousState String?
  userAgent     String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UtilityTransaction {
  id          String    @id @default(cuid())
  reference   String    @unique
  utilityType String
  meterNumber String
  token       String?
  amount      Float
  commission  Float     @default(0)
  totalPaid   Float
  status      String
  provider    String
  userId      String
  propertyId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  property    Property? @relation(fields: [propertyId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
}

model UtilityProvider {
  id         String   @id @default(cuid())
  name       String   @unique
  isActive   Boolean  @default(true)
  commission Float    @default(100)
  minAmount  Float    @default(1000)
  maxAmount  Float    @default(50000)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model RentModificationLog {
  id             String   @id @default(cuid())
  leaseId        String
  previousAmount Float
  newAmount      Float
  reason         String?
  adminId        String
  createdAt      DateTime @default(now())
  admin          User     @relation("AdminModifier", fields: [adminId], references: [id])
  lease          Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
}

model TenantProfile {
  id                         String    @id @default(cuid())
  userId                     String    @unique
  nationality                String?
  maritalStatus              String?
  gender                     String?
  dateOfBirth                DateTime?
  spouseName                 String?
  spouseWork                 String?
  residentialAddress         String?
  nearestBusStop             String?
  homeTownAddress            String?
  stateOfOrigin              String?
  lga                        String?
  occupation                 String?
  placeOfWork                String?
  positionHeld               String?
  placeOfWorship             String?
  bankDetails                String?
  meansOfIdentification      String?
  idNumber                   String?
  idIssueDate                DateTime?
  idExpiryDate               DateTime?
  companyName                String?
  incorporationDate          DateTime?
  certificateNumber          String?
  businessType               String?
  banker                     String?
  corporateEmail             String?
  corporateWebsite           String?
  contactPersonName          String?
  contactPersonPhone         String?
  corporateAddress           String?
  branchOffice               String?
  propertyTypeRequired       String?
  locationRequired           String?
  acceptOtherLocation        Boolean?
  businessDescription        String?
  tenancyNature              String?
  commencementDate           DateTime?
  budgetPerAnnum             String?
  leasePreference            String?
  leaseYears                 Int?
  serviceChargeAffordability Boolean?
  cautionDepositAgreement    Boolean?
  lastAddress                String?
  lastSize                   String?
  lastRentPaid               String?
  periodOfPayment            String?
  expirationDate             DateTime?
  lastLandlordNameAddress    String?
  reasonForLeaving           String?
  guarantors                 Json?
  agreedToTerms              Boolean   @default(false)
  signatureUrl               String?
  updatedAt                  DateTime  @updatedAt
  user                       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LandlordProfile {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  landlordType           String?
  idType                 String?
  idNumber               String?
  residentialAddress     String?
  relationshipToProperty String?
  proofOfAuthorityUrl    String?
  bankName               String?
  accountName            String?
  accountNumber          String?
  preferredContactMethod String?
  isConsentGiven         Boolean   @default(false)
  consentDate            DateTime?
  updatedAt              DateTime  @updatedAt
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LandlordExpense {
  id          String        @id @default(cuid())
  amount      Float
  description String
  date        DateTime      @default(now())
  status      ExpenseStatus @default(PENDING)
  ticketId    String?       @unique
  propertyId  String
  landlordId  String
  payoutId    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  landlord    User          @relation(fields: [landlordId], references: [id])
  payout      Payout?       @relation(fields: [payoutId], references: [id])
  property    Property      @relation(fields: [propertyId], references: [id])
  ticket      Ticket?       @relation(fields: [ticketId], references: [id])
}

model Payout {
  id              String            @id @default(cuid())
  reference       String            @unique
  landlordId      String
  amount          Float
  periodStart     DateTime
  periodEnd       DateTime
  status          String            @default("PENDING")
  expenseSnapshot Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  rentCycleId     String?
  propertyId      String?
  description     String?
  expenses        LandlordExpense[]
  landlord        User              @relation(fields: [landlordId], references: [id])
  property        Property?         @relation("PropertyPayouts", fields: [propertyId], references: [id])
  rentCycle       RentCycle?        @relation(fields: [rentCycleId], references: [id])
}

model RentCycle {
  id         String   @id @default(cuid())
  startDate  DateTime
  endDate    DateTime
  status     String   @default("OPEN")
  landlordId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  payouts    Payout[]
  landlord   User     @relation(fields: [landlordId], references: [id])
  tickets    Ticket[]
}

model MonthlyMetric {
  id                 String    @id @default(cuid())
  month              DateTime
  landlordId         String?
  propertyId         String?
  totalRentCollected Float     @default(0)
  occupancyRate      Float     @default(0)
  activeTickets      Int       @default(0)
  churnRate          Float     @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  landlord           User?     @relation(fields: [landlordId], references: [id])
  property           Property? @relation(fields: [propertyId], references: [id])

  @@unique([month, landlordId, propertyId])
}

enum Role {
  ADMIN
  STAFF
  TENANT
  USER
  LANDLORD
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

enum PropertyStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  SOLD
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  PENDING
  AWAITING_CONFIRMATION
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ApprovalStatus {
  PENDING_MANAGER
  PENDING_ADMIN
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum NotificationType {
  MAINTENANCE
  PAYMENT
  CHAT
  ALERT
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum TicketPayerType {
  LANDLORD
  COMPANY
}

enum TenantConfirmationStatus {
  PENDING
  CONFIRMED
  DISPUTED
}

enum ExpenseStatus {
  PENDING
  APPROVED
  DEDUCTED
  REJECTED
}
